{% extends 'layout.html' %}
{% block content %}

<h2 class="mb-4">ðŸ“‡ Add New Contact</h2>
<form method="POST">
  <div class="mb-3">
    <label class="form-label">Full Name <span class="text-danger">*</span></label>
    <input name="name" class="form-control" required>
  </div>
  <div class="mb-3">
    <label class="form-label">Email Address</label>
    <input name="email" class="form-control">
  </div>
  <div class="mb-3">
    <label class="form-label">Phone Number</label>
    <input name="phone" class="form-control">
  </div>
  <div class="mb-3">
    <label class="form-label">Role <span class="text-danger">*</span></label>
    <input name="role" class="form-control" required>
  </div>
  <div class="mb-3">
    <label class="form-label">Location</label>
    <input name="location" class="form-control">
  </div>
  <div class="mb-3">
    <label class="form-label">Technology</label>
    <input name="technology" class="form-control">
  </div>
  <div class="mb-3">
    <label class="form-label">Reports To</label>
    <select name="reports_to" id="reportsToSelect" class="form-select">
      <option value="">-- None --</option>
    </select>
  </div>
  <div class="mb-3">
    <label class="form-label">Contact Type <span class="text-danger">*</span></label>
    <select name="contact_type" class="form-select" onchange="toggleAssociationFields()" required>
      <option value="Cisco">Cisco</option>
      <option value="Partner">Partner</option>
      <option value="Customer">Customer</option>
    </select>
  </div>

  <div class="mb-3" id="customerField" style="display: none;">
    <label class="form-label">Select Customer</label>
    <select name="customer_id" class="form-select">
      <option value="">-- Select --</option>
      {% for customer in customers %}
      <option value="{{ customer.id }}">{{ customer.name }}</option>
      {% endfor %}
    </select>
  </div>

  <div class="mb-3" id="partnerField" style="display: none;">
    <label class="form-label">Select Partner</label>
    <select name="partner_id" class="form-select">
      <option value="">-- Select --</option>
      {% for partner in partners %}
      <option value="{{ partner.id }}">{{ partner.name }}</option>
      {% endfor %}
    </select>
  </div>

  <div class="mb-4" id="divisionSection" style="display: none;">
    <label class="form-label">Assign to Divisions (optional)</label>
    <div id="divisionCheckboxes" class="row"></div>
  </div>
  

  <div class="mb-3">
    <label class="form-label">Additional Notes</label>
    <textarea name="notes" class="form-control"></textarea>
  </div>

  <button class="btn btn-success">Add Contact</button>
</form>

<!-- Contact data for JS -->
<script id="contacts-json" type="application/json">
  {{ contacts_by_type | tojson }}
</script>

<script>
  const contactData = JSON.parse(document.getElementById('contacts-json').textContent);

  function updateReportsToOptions(type) {
    const select = document.getElementById('reportsToSelect');
    select.innerHTML = '<option value="">-- None --</option>';

    if (type === 'Customer') {
      const selectedCustomerId = document.querySelector('[name="customer_id"]').value;
      const list = contactData.Customer[selectedCustomerId] || [];
      list.forEach(contact => {
        const option = document.createElement('option');
        option.value = contact.id;
        option.textContent = contact.name;
        select.appendChild(option);
      });
    } else {
      const list = contactData[type] || [];
      list.forEach(contact => {
        const option = document.createElement('option');
        option.value = contact.id;
        option.textContent = contact.name;
        select.appendChild(option);
      });
    }
  }

  function toggleAssociationFields() {
    const type = document.querySelector('[name="contact_type"]').value;
    document.getElementById('customerField').style.display = type === 'Customer' ? 'block' : 'none';
    document.getElementById('partnerField').style.display = type === 'Partner' ? 'block' : 'none';
    updateReportsToOptions(type);
  }

  document.addEventListener('DOMContentLoaded', () => {
    toggleAssociationFields();

    document.querySelector('[name="customer_id"]').addEventListener('change', () => {
      const type = document.querySelector('[name="contact_type"]').value;
      if (type === 'Customer') {
        updateReportsToOptions(type);
      }
    });

    document.querySelector('[name="contact_type"]').addEventListener('change', toggleAssociationFields);
  });
</script>

<script id="customer-divisions-json" type="application/json">
  {{ customer_divisions | tojson }}
</script>

<script>
  const customerDivisions = JSON.parse(document.getElementById('customer-divisions-json').textContent);

  function updateDivisionCheckboxes() {
    const selectedCustomerId = document.querySelector('[name="customer_id"]').value;
    const divisions = customerDivisions[selectedCustomerId] || [];
    const container = document.getElementById('divisionCheckboxes');
    const section = document.getElementById('divisionSection');

    container.innerHTML = '';
    
    if (divisions.length) {
      section.style.display = 'block';
      divisions.forEach(d => {
        const div = document.createElement('div');
        div.className = 'col-md-4';
        div.innerHTML = `
          <div class="form-check">
            <input class="form-check-input" type="checkbox" name="division_ids" value="${d.id}">
            <label class="form-check-label">${d.name}</label>
          </div>
        `;
        container.appendChild(div);
      });
    } else {
      section.style.display = 'none';
    }
  }

  document.addEventListener('DOMContentLoaded', () => {
    // already there:
    toggleAssociationFields();

    document.querySelector('[name="customer_id"]').addEventListener('change', () => {
      const type = document.querySelector('[name="contact_type"]').value;
      if (type === 'Customer') {
        updateReportsToOptions(type);
        updateDivisionCheckboxes();  // âœ… ADD THIS
      }
    });

    document.querySelector('[name="contact_type"]').addEventListener('change', () => {
      toggleAssociationFields();
      updateDivisionCheckboxes();  // âœ… ADD THIS TOO
    });
  });

  document.addEventListener("DOMContentLoaded", function () {
    document.addEventListener("keydown", function (event) {
      if ((event.key === "Escape" || event.keyCode === 27) &&
          document.activeElement.tagName !== "TEXTAREA" &&
          document.activeElement.tagName !== "INPUT") {
        
        event.preventDefault(); // Prevent default Escape behavior (like modal close)
        console.log("Forced redirect on Esc");

        setTimeout(() => {
          window.location.href = "/contacts";
        }, 100);
      }
    });
  });


</script>


{% endblock %}
