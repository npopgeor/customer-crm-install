{% extends 'layout.html' %}

{% macro render_tree(contact, seen) %}
  {% if contact.id not in seen %}
    {% set _ = seen.append(contact.id) %}
    <li>
      {{ contact.name }} â€“ {{ contact.role }}
      {% if contact.email %}
        (<a href="mailto:{{ contact.email }}">{{ contact.email }}</a>)
      {% endif %}
      {% if contact.subordinates %}
        <ul>
          {% for sub in contact.subordinates %}
            {{ render_tree(sub, seen) }}
          {% endfor %}
        </ul>
      {% endif %}
    </li>
  {% endif %}
{% endmacro %}

{% block content %}
<div class="container-fluid">
  <div class="d-flex justify-content-between align-items-center mb-3">
    <h2>{{ customer.name }}</h2>
    <a href="{{ url_for('edit_customer', id=customer.id) }}" class="btn btn-sm btn-outline-secondary">Edit</a>
  </div>

  {% if customer.notes %}
    <p><strong>Notes:</strong> {{ customer.notes }}</p>
  {% endif %}

  {% if customer.partners %}
    <p><strong>Partners:</strong>
      {% for partner in customer.partners %}
        <a href="{{ url_for('partner_detail', partner_id=partner.id) }}">{{ partner.name }}</a>{% if not loop.last %}, {% endif %}
      {% endfor %}
    </p>
  {% endif %}

  <!-- ğŸ§­ Tab Navigation -->
  <ul class="nav nav-tabs mt-4" id="customerTabs" role="tablist">
    <li class="nav-item">
      <button class="nav-link active" id="contacts-tab" data-bs-toggle="tab" data-bs-target="#contacts" type="button">ğŸ‘¥ Contacts</button>
    </li>
    <li class="nav-item">
      <button class="nav-link" id="opps-tab" data-bs-toggle="tab" data-bs-target="#opportunities" type="button">ğŸ’¼ Opportunities</button>
    </li>
    <li class="nav-item">
      <button class="nav-link" id="discounts-tab" data-bs-toggle="tab" data-bs-target="#discounts" type="button">ğŸ“‰ Discounts</button>
    </li>
    <li class="nav-item">
      <button class="nav-link" id="projects-tab" data-bs-toggle="tab" data-bs-target="#projects" type="button">ğŸ›  Projects</button>
    </li>
    <li class="nav-item">
      <button class="nav-link" id="attachments-tab" data-bs-toggle="tab" data-bs-target="#attachments" type="button">ğŸ“ Attachments</button>
    </li>
  </ul>

  <!-- âœ¨ Tab Contents -->
  <div class="tab-content mt-3" id="customerTabContent">

    <!-- ğŸ‘¥ Contacts Tab -->
    <div class="tab-pane show active" id="contacts" role="tabpanel">
      {% if contact_tree %}
        <ul class="tree">
          {% for contact in contact_tree if not contact.reports_to %}
            {{ render_tree(contact, []) }}
          {% endfor %}
        </ul>
      {% else %}
        <p class="text-muted">No contacts available.</p>
      {% endif %}
    </div>

    <!-- ğŸ’¼ Opportunities Tab -->
    <div class="tab-pane" id="opportunities" role="tabpanel">
      <div class="d-flex justify-content-between align-items-center mb-3">
        <h5>Opportunities</h5>
        <button class="btn btn-sm btn-outline-primary" data-bs-toggle="modal" data-bs-target="#addOpportunityModal">â• Add Opportunity</button>
      </div>

      {% if customer.opportunities %}
      <ul class="list-group">
        {% for opp in customer.opportunities %}
        <li class="list-group-item">
          <div class="d-flex justify-content-between align-items-start">
            <div>
              <strong>{{ opp.title }}</strong> â€“ {{ opp.stage or 'No stage' }}
              {% if opp.value %}<span class="badge bg-primary ms-2">${{ opp.value }}</span>{% endif %}<br>
              <small class="text-muted">Created: {{ opp.date_added.strftime('%b %d, %Y') if opp.date_added else 'â€”' }}</small><br>
              <small class="text-muted">{{ opp.notes or 'â€”' }}</small>
              {% if opp.next_steps %}
              <div><strong>Next steps:</strong> <small class="text-muted">{{ opp.next_steps }}</small></div>
              {% endif %}
            </div>
            <div class="btn-group btn-group-sm">
              <button class="btn btn-outline-secondary" data-bs-toggle="modal" data-bs-target="#editOpportunityModal{{ opp.id }}">âœï¸</button>
              <form method="POST" action="{{ url_for('delete_opportunity', opp_id=opp.id) }}" onsubmit="return confirm('Delete this opportunity?')">
                <button class="btn btn-outline-danger">ğŸ—‘ï¸</button>
              </form>
            </div>
          </div>
        </li>

        <!-- ğŸ“ Edit Modal -->
        <div class="modal fade" id="editOpportunityModal{{ opp.id }}" tabindex="-1">
          <div class="modal-dialog">
            <form method="POST" action="{{ url_for('edit_opportunity', opp_id=opp.id) }}">
              <div class="modal-content">
                <div class="modal-header"><h5 class="modal-title">Edit Opportunity</h5></div>
                <div class="modal-body">
                  <label class="form-label">Title</label>
                  <input name="title" class="form-control mb-2" value="{{ opp.title }}" placeholder="Technology or Title" required>
                  <label class="form-label">Stage</label>
                  <input name="stage" class="form-control mb-2" value="{{ opp.stage }}" placeholder="Stage (e.g. Identified, POC)">
                  <label class="form-label">Value</label>
                  <input name="value" class="form-control mb-2" value="{{ opp.value }}" placeholder="Potential Value ($)">
                  <label class="form-label">Notes</label>
                  <textarea name="notes" class="form-control mb-2" rows="3" placeholder="Notes or context...">{{ opp.notes }}</textarea>
                  <label class="form-label">Next Steps</label>
                  <textarea name="next_steps" class="form-control mb-2" rows="2" placeholder="Next Steps...">{{ opp.next_steps }}</textarea>
                  <small class="text-muted">Last updated: {{ opp.last_updated.strftime('%b %d, %Y') if opp.last_updated else 'â€”' }}</small>
                </div>
                <div class="modal-footer">
                  <button class="btn btn-primary">ğŸ’¾ Save</button>
                  <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">âŒ Cancel</button>
                </div>
              </div>
            </form>
          </div>
        </div>
        {% endfor %}
      </ul>
      {% else %}
      <p class="text-muted">No opportunities added yet.</p>
      {% endif %}
    </div>

    <!-- â• Add Opportunity Modal -->
    <div class="modal fade" id="addOpportunityModal" tabindex="-1">
      <div class="modal-dialog">
        <form method="POST" action="{{ url_for('add_customer_opportunity', customer_id=customer.id) }}">
          <div class="modal-content">
            <div class="modal-header"><h5 class="modal-title">Add New Opportunity</h5></div>
            <div class="modal-body">
              <label class="form-label">Title</label>
              <input name="title" class="form-control mb-2" placeholder="Technology or Title" required>
              <label class="form-label">Stage</label>
              <input name="stage" class="form-control mb-2" placeholder="Stage (e.g. Identified, POC)">
              <label class="form-label">Value</label>
              <input name="value" class="form-control mb-2" placeholder="Potential Value ($)">
              <label class="form-label">Notes</label>
              <textarea name="notes" class="form-control mb-2" rows="2" placeholder="Notes or context..."></textarea>
              <label class="form-label">Next Steps</label>
              <textarea name="next_steps" class="form-control" rows="2" placeholder="Next Steps..."></textarea>
            </div>
            <div class="modal-footer">
              <button class="btn btn-primary">ğŸ’¾ Save</button>
              <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">âŒ Cancel</button>
            </div>
          </div>
        </form>
      </div>
    </div>
  </div>
</div>

<script>
    document.addEventListener("DOMContentLoaded", function () {
      document.addEventListener("keydown", function (event) {
        if ((event.key === "Escape" || event.keyCode === 27) &&
            document.activeElement.tagName !== "TEXTAREA" &&
            document.activeElement.tagName !== "INPUT") {
          
          event.preventDefault(); // Prevent default Escape behavior (like modal close)
          console.log("Forced redirect on Esc");
  
          setTimeout(() => {
            window.location.href = "/dashboard";  // âœ… Change this per page
          }, 100);
        }
      });
    });
  </script>
  

{% endblock %}
